\chapter{ペアリング}
%Pairing, divisor, 埋め込み次数の定義, Weil Pairing, Tate Pairing, Miller's Algorithmについて書く.
\par
\section{ペアリングの定義}
\par
$n$を整数とする．$G_1,G_2$を単位元0の加法アーベル群とする．$G_1,G_2$は位数$n$を持つ．$G_3$は単位元1の乗法に関する位数$n$の巡回群とする．ペアリングというのは以下の関数である．
\[
e:G_1\times G_2\longrightarrow G_3
\]
全てのペアリングは以下の2つの性質を満たす．\\
\begin{description}
\item[\textbf{・双線形性}]
全ての$P,P' \in G_{1}$と$Q,Q' \in G_{2}$に対して，

e(P+P',Q) = e(P,Q) + e(P',Q),

e(P,Q+Q') = e(P,Q) + e(P,Q')が成り立つ．\\

\item[\textbf{・非退縮性}] \hspace{0em}\\\vspace{-2em}

\item 全ての$P \in G_{1} \ (P \not= 0)$に対して $e(P,Q) \not= 1$となるような$Q \in G_{2}$が存在する．
\item 全ての$Q \in G_{2} \ (P \not= 0)$に対して $e(P,Q) \not= 1$となるような$P \in G_{1}$が存在する．

\end{description}

\par
\section{ペアリングと関係する様々な定義}
\par

\subsection{divisorの定義}
$C$を体$K$上の楕円曲線とし，$C(\overline{K})$を体$K$上の代数閉包上で定義される全ての有理点の集合とする．$C$上のdivisorとは，次のような形式和で表される．
\[
D=\sum\limits_{P\in (C(\overline{K})}n_P(P)
\]
このとき，$n_P\in \mathbb {Z}$は有限であり，$D$は$n_P=0$となるようなものを除いたものとする．$C$上のdivisorの集合はDiv$_{\overline{K}}(C)$
で表され，加法に関して群構造をなす．divisor $D$の台とは，supp$(D) = \langle P \in E|n_P \neq 0 \rangle$であるとする．divisor $D$の次数とはdeg$(D)=\sum\limits_{P}n_P$であるとする． divisor $D$の和とは，sum$(D)=\sum n_PP$であるとする．\\
もし, 直線$f$が$C$上で零でない関数だとすると，点$P$における$f$の重複度ord$_P(f)$を数えることができる．ord$_P(f)$は$f(P)=0$のとき正であり，$f$が点$P$で極ならば負である．また，ord$_P(f)$が1ならば$f=0$と$E$が交差し、2ならば$f=0$が$E$に接し$3P\neq \mathcal{O}$となり，3ならば$f=0$が$E$に接し$3P=\mathcal{O}$となる．零でない関数$f$のdivisorは$(f)$と書き，
\[
\sum\limits_{P\in C(\overline K)}{\rm ord}_P(f)(P)
\]
である．これにより，直線$f,g$のdivisorの計算は$(fg)=(f)+(g)$となり$(f/g)=(f)-(g)$となることがわかる．\\
また，$C$のprincipal divisorとはある関数$f$に対して$(f)$と等しいdivisorのことである．このとき，deg$((f))=0$となる．点$(P,Q)$を通る直線$l_{P,Q}$を考えたとき，この直線のdivisorを求める公式は
\[
{\rm div}(l_{P,Q})=(P)+(Q)+(-(P+Q))-3(\mathcal{O})
\]
で表される．
\par
\subsection{埋め込み次数の定義}
$K _0 = \mathbb{F} _q$を有限体とする．
$E$を$K _0$上で定義された楕円曲線とし，$\# E(K _0)$で割り切られ，$q$と素な整数を$n$とする．
体$K = K _0 (\mu _n)$はある拡大体$\mathbb{F} _{q ^{k}}$とする．
$k$は埋め込み次数や安定乗数と呼ばれ，$(q ^k -1)$が$n$を割り切るようなような最小の正整数である．
$k$というのは，$q$と$n$の関数$k(q, n)$である．
$k$は$n$を法とした$q$の位数なので，$k$は$\phi  _{Eul} (n)$(オイラーの$\phi$関数)で割り切られる．
\par
任意の体$K$と任意の楕円曲線$E$に関して，もし$n$を$\# E(\mathbb{F} _q)$の大きなdivisorとすると，埋め込み次数$k$は大抵の場合とても大きく(bitも$n$と同じ数だけある)，そのため体$\mathbb{F} _{q ^k}$上の計算は指数的に複雑になる．\\
\par
\section{Weilの定理}
\par
ある楕円曲線$E/\mathbb {F}_q$に対して，曲線上の有理点の集合$E(\mathbb {F}_q)$を考える．このとき，$E(\mathbb {F}_{q^m})$の位数$\# E(\mathbb {F}_{q^m})$は$E(\mathbb {F}_q)$の位数$\# E(\mathbb {F}_q)$を用いて次のように求められる．
\begin{eqnarray*}
\# E(\mathbb {F}_{q^m})&=&q^m+1-t_{[m]}\\
t_{[m]}&=&\alpha ^m+\beta ^m
\end{eqnarray*}
ただし，$t$を$E(\mathbb {F}_q)$のトレース\ $t=q+1-\# E(\mathbb {F}_q)$とする．このとき，$|t|\le 2 \sqrt{q}$が成り立つ．また，$\alpha ,\beta $は$\alpha \beta =q,\alpha +\beta =t$を満たす複素数である．$t_{[m]}$は$E(\mathbb {F}_{q^m})$のトレースとする．$t_{[m]}$は$E(\mathbb {F}_q)$のトレースを用いて次式で与えられる．
\begin{eqnarray*}
t_{[m]}=\sum\limits _{i=0}^{\left\lfloor m/2\right\rfloor}\frac{m}{m-i} {}_{m-i}C_i(-q)^it^{m-2i}
\end{eqnarray*}ここで，$\left\lfloor m/2\right\rfloor$は$m/2$以下の最大の整数を意味する．Weilの定理を用いることで，定義体を拡大体とした場合の楕円曲線の位数を求めることができ，$\# E(\mathbb {F}_q)$は$\# E(\mathbb {F}_{q^m})$を割り切ることがわかる．\\
\par
\section{Weil ペアリング}
\par
$E$を$K _0$上で定義された楕円曲線とし，$n$を$K _0$の標数と互いに素な整数とする．
$n$で割り切れる位数の$E(\overline{K})$のすべての点の座標で生成された$K _0$の拡大体を$K = K _0(E[n])$で定義する．
Weilペアリングというのは，写像
\[
e _n: E[n] \times E[n] \to \mu _n \subseteq K ^*
\]
で定義される．
$\mu _n$は$\overline{K}$の単位元の$n$乗根とする．
\par
$T \in E[n]$とする．
このとき，${\rm div} (f) = n(T) - n(\mathcal{O})$なる関数$f$が存在する．
$nT' = T$となるような$T' \in E[n ^2]$を選ぶと，${\rm div}(g) = \sigma _{R \in E[n]} ((T' + R) - (R))$
なる関数$g$が存在する．
このとき，点$R \in E[n]$には$n ^2$となる要素が含まれており，その場合は$\sigma (T' + R)$と$\sigma (R)$は
打ち消される．
$g$は$T'$の値によらないので，2つの違う$T'$を取ってきてもそれは$R$による．
よって，${\rm div}(g) = \sigma _{nT'' = T} (T'') - \sigma _{nR = \mathcal{O}} (R)$と表される．
\par
$f \circ n$をある点を$n$倍した後に関数$f$を適応させるような関数とする．
$R \in E[n]$であるような$P = T' + R$を選んだとき，$nP = T$である．
このとき，${\rm div}(f \circ n) = n(\sigma _R (T' + R)) - n(\sigma _R (R)) = {\rm div}(g ^n)$であり，
$f \circ n$は$g ^n$の定数倍である．
適当に$f$を倍算したものを考えれば，$f \circ n = g ^n$である．
$S \in E[n]$とし$P \in E(\overline{K})$とすると，
$g(P + S) ^n = f(n(P + S)) = f(nP) = g(P) ^n$となる．
よって$g(P + S) / g(P) \in \mu _n$となる．
$g(P + S) / g(P)$は$P$と独立となる．
\par
以上より，Weilペアリングというのは，
\[
e _n(S, T) = \frac{g(P + S)}{g(P)}
\]
で定義される．
\par
Weil ペアリングは以下の特性を満たす．
\begin{enumerate}
  \item (双線形性) すべての$P, P', Q, Q' \in E[n]$に対して，
  \[
  e _n(P + P', Q) = e _n(P, Q) e _n(P', Q)
  \]
  かつ
  \[
  e _n(P, Q + Q') = e _n(P, Q) e _n(P, Q')
  \]
  \item (一意性) 全ての$P \in E[n]$に対して，$e(P, P) = 1$
  \item (交換性) 全ての$P, Q \in E[n]$に対して，$e _n(P, Q) = e _n(Q, P) ^{-1}$
  \item (非退化) もし全ての$Q \in E[n]$において$e _n(P, Q) = 1$ならば，$P = \mathcal{O}$
  \item (適合性) もし$P \in E[n m]$かつ$Q \in E[n]$ならば，
  \[
  e _{n m}(P, Q) = e _n([m]P, Q)
  \]
  \item もし$\phi:E \to E'$が2つの$\hat{\phi}$をもつ同種写像であるならば，
  \[
  e _n(\phi(P), Q) = e _n(P, \hat{\phi}(Q))
  \]
\end{enumerate}
\section{Tate ペアリング}
\par
$P \in E(\mathbb{F}_q)[n]$に対してdiv($f_{n, P})=n(P)-n(\mathcal{O})$となる有理関数$f_{n,P} \in E(\mathbb{F}_q)$が存在する. すべての点を$n$倍して得られることなる点の集合を$nE(\mathbb{F}_{q^k})$とすると, その剰余類全体の集合を$E(\mathbb{F}_{q^k})/nE(\mathbb{F}_{q^k})$と表現する. 剰余類の代表元を$Q$として, $D \sim (Q) - (\mathcal{O})$となる因子$D \in \mbox{Div}^0(E)$を選択する. supp(div($f_{n, P})) \cap \mbox{supp} (D) = \not 0$を満足するようにランダムに選んだ点$R \in E(\mathbb{F}_{q^k})$を利用して$D=(Q + R) - (R)とおくと,\ f_{n,P}(D)$を計算可能である. Tate ペアリングは次のように定義可能である.
\par
\[
\langle \cdot,\cdot\rangle_n:
\left\{
\begin{array}{l}
E(\mathbb{F}_q)[n] \times E(\mathbb{F}_{q^k})/nE(\mathbb{F}_{q^k}) \to \mathbb{F}_{q^k}^\ast /(\mathbb{F}_{q^k}^\ast)^n\\
(P,Q) \mapsto \langle P, Q \rangle _n = f_{n,P}(D)
\end{array}
\right.
\]
\par
Tate ペアリングの値は剰余類全体の集合$\mathbb{F}_{q^k}^\ast/(\mathbb{F}_{q^k}^\ast)^n$に属しており, 一意に定まらない. すなわち, 二つの元$a,\ b \in \mathbb{F}_{q^k}^\ast が元c \in \mathbb{F}_{q^k}を用いてa = bc^n$と表現可能なとき, $a,\ b$は合同となる.ペアリングを利用する方式では$\mathbb{F}_{q^k}^\ast$における一意に定まる値が必要がため, $c^n$を消去する必要がある. $a^{q^k - 1} = 1,\ a \in \mathbb{F}_{q^k}^\ast$の性質を利用して, Tate ペアリングの値に最終べき乗$(q^k - 1) / n$を行うことにより, 一意な値を得ることが可能である. Tate ペアリングの値を最終べき乗したReduced Tate ペアリングを次のように定義する.
\par
\[
P \in E(\mathbb{F}_q)[n],\ Q \in E(\mathbb{F}_{q^k}),\ \mu_n = \left\{ x \in \mathbb{F}_{q^k}^\ast | x^n = 1 \right\}
\]

\[
\tau \langle P,Q \rangle = \langle P,Q \rangle _n^{(q^k - 1) / n} = f_{n,P}(Q)^{(q^k - 1) / n} \in \mu_n
\]
\par
さらに, Reduced Tate ペアリングの重要な性質として$N = hn$に対して次の式が成立する.
\par
\[
\tau(P,Q) = \langle P,Q \rangle _n^{(q^k - 1) / n}
\]
\par
これにより, $n$をHamming Weightが小さい$N = hn \in \mathbb{N}$に変更することにより, Miller Algorithmにおけるループ回数は部分群の位数$n$を用いる場合に比べ増加するが, アルゴリズムの総計算量の低減が期待できる.
Tateペアリングは以下のような性質を持つ．
\begin{enumerate}
  \item (双線形性) 全ての$P, P', Q, Q' \in E[n]$に対して，
  \[
  \langle P + P', Q \rangle _n = \langle P, Q \rangle _n \langle P', Q \rangle _n
  \]
  かつ
  \[
  \langle P, Q + Q' \rangle _n = \langle P, Q \rangle _n \langle P, Q' \rangle _n
  \]
  \item (非退化) $\mathbb{F}_{q^k}$を有限体とする．全ての$P \in E(\mathbb{F}_{q^k})[n] \ (P \not= 0)$に対して，
  $\langle P, Q\rangle _n \not= 1$となるような$Q \in E(\mathbb{F}_{q^k}) / nE(\mathbb{F}_{q^k})$が存在する．
  同様にして，全ての$Q \in E(\mathbb{F}_{q^k}) / nE(\mathbb{F}_{q^k}) \ (Q \notin nE(\mathbb{F}_{q^k}))$に対して，
  $\langle P, Q\rangle _n \not= 1$となるような$P \in E(\mathbb{F}_{q^k})[n]$が存在する．
  \item (ガロアの不変性) もし$\sigma \in \rm{Gal}\it{(\overline{\mathbb{F}}_{q^k} / \mathbb{F}_q)}$とすると，
  $\langle \sigma (P), \sigma (Q) \rangle _n = \sigma(\langle P, Q \rangle _n)$
  である．
\end{enumerate}

\par
\section{Miller Algorithm}
\par
Miller Algorithm\cite{MIA}とは，Weilペアリングを多項式時間で求めるアルゴリズムである．
また，Miller AlgorithmはTateペアリングの計算にも用いることができる．TateペアリングにおいてMiller Algorithmを考える．定義式
\[
f_P(D_Q)^{{(q^k-1)}/n}
\]
から，以下の条件を満たす有理関数$f_P$の計算に帰着される．
\[
{\rm div}(f_P)=n(P)-n(\mathcal{O})
\]
ここで$f_h$を
\[
{\rm div}(f_h)=h(P)-(hP)-(h-1)(\mathcal{O})
\]
を満たす有理関数とする．点$iP$と$jP$を通る直線を$l_{iP,jP}$とし，点$(i+j)P$を通る垂線を$v_{(i+j)P}$とすると，Miller Algorithm中で再帰的に$f_P=f_h$を求めるための基本公式
\[
{\rm div}(f_{i+j})-{\rm div}(f_i)-{\rm div}(f_j)={\rm div}\Bigl(\frac{l_{iP,jP}}{v_{(i+j)P}}\Bigr)
\]
は次のように証明される．
\begin{proof}
直線のdivisorの公式
\[
{\rm div}(l_{P,Q})=(P)+(Q)+(-(P+Q))-3(\mathcal{O})
\]
より，
\begin{eqnarray*}
{\rm div}\Bigl(\frac{l_{iP,jP}}{v_{(i+j)P}}\Bigr)&=&{\rm div}(l_{iP,jP})-{\rm div}(v_{(i+j)P})\\
&=&\left\{(iP)+(jP)+(-(i+j)P)-3(\mathcal{O})\right\}-\left\{((i+j)P)+(-(i+j)P)-2(\mathcal{O})\right\}\\
&=&(iP)+(jP)-((i+j)P)-(\mathcal{O})
\end{eqnarray*}となる．一方$f_h$の定義から
\begin{eqnarray*}
{\rm div}(f_{i+j})-{\rm div}(f_i)-{\rm div}(f_j)&=&\left\{(i+j)P-((i+j)P)-(i+j-1)(\mathcal{O})\right\}\\
&\ \ \ &-\left\{i(P)-(iP)-(i-1)(\mathcal{O})\right\}-\left\{j(P)-(jP)-(j-1)(\mathcal{O})\right\}\\
&=&(iP)+(jP)-((i+j)P)-(\mathcal{O})
\end{eqnarray*}が得られ，両者は等しくなる．\\
従って
\[
{\rm div}(f_{i+j})={\rm div}(f_i)+{\rm div}(f_j)+{\rm div}\Bigl(\frac{l_{iP,jP}}{v_{(i+j)P}}\Bigr)={\rm div}\Bigl(f_if_j\frac{l_{iP,jP}}{v_{(i+j)P}}\Bigr)
\]
これより，再帰的公式
\[
f_{i+j}=\Bigl(f_if_j\frac{l_{iP,jP}}{v_{(i+j)P}}\Bigr)
\]が得られた．
\end{proof}
これを用いてMiller Algorithmは，$(f) = n(P) - n(\mathcal{O})$となるような関数$f$を構成している．次にMiller Algorithmを示す.$l= \log _2 (n)$とし, 点$U$, $V ∈ E(F_{q^k})$ を通る直線の方程式を $g_{U,V}$ とする。$U=V$の場合$V$を通る \\

\par
\begin{table}[htbp]
 \begin{center}
  \begin{tabular}{|l|}
     \hline
     Input: $n, \ P \in E(\mathbb{F}_q)[n], \ Q \in E(\mathbb{F}_{q^k})$ \\
     Output: $f \in \mathbb{F}_{q^k}$  \\
     \hline
     1: \quad $Q' \in _R E(\mathbb{F}_{q^k})$\\
     2: \quad $S=Q+Q' \in E(\mathbb{F}_{q^k})$\\
     3: \quad $V \gets P, \ f \gets 1$\\
     4: \quad $n=\sum^{l-1}_{i=0} n_i 2^i, \ n_i \in {0,1}$\\
     5: \quad for $j \gets l-1$ down do 0\\
     6: \quad \quad $f \gets f^2 \cdot \frac{g_{V,V}(S)g_{2V}(Q')}{g_{2V}(S)g_{V,V}(Q')}$\\
     7: \quad \quad $V \gets 2V$\\
     8: \quad if $n_j = 1$ then\\
     9: \quad \quad $f \gets f \cdot \frac{g_{V,P}(S)g_{V+P}(Q')}{g_{V+P}(S)g_{V,P}(Q')}$\\
     10: \quad \quad $V \gets V+P$\\
     11: \quad return $f$\\
     \hline
   \end{tabular}
 \end{center}
 \caption{Miller Algorithm}
\end{table}
\par
Miller Algorithmの主な反復は$l$の繰り返しなので，二重の操作は$l$時間で成し遂げられる．
5行目から10行目までの掛け算と足し算の演算は$n$のHamming Weight以下で計算される．
それゆえMiller Algorithmは多項式時間で動作する．
\par
適当な点$S$を選ぶ1つの方法としては，$E(\mathbb{F}_{q^k})$上の点をランダムに選ぶことである．
$n$が大きいとき，このアルゴリズムは$S = [i]P$を取ることによって容易に決定的になる．
このとき，$i$の2進展開は$n$の2進展開の一部ではないとする($P \in E(\mathbb{F} _q)$かつ$Q \in E(\mathbb{F} _q)$ならば$S = Q$を取る)．
\par
このアルゴリズムの変化量は，直線プログラムとして関数$f$に対して明確な表示で出力される(例えば，もしそれが因数分解された形式を保つならば，小さな多項式の累乗の積として多項式の保存を必要とする)．\\

\par
\section{distortion map}
\par

distortion mapというのは，$E(\mathbb{F} _q)$上の点を$E(\mathbb{F} _{q ^k})$上の点に写像するような
非線形な自己準同型写像である．
点$P \in E(\mathbb{F} _q)$が位数$n$の点を持つとし，$k > 1$とする．
$E(\mathbb{F} _{q ^k})$は位数$n ^2$の点を持たないとすると，$E$上の準同型$\psi$によって
$\psi(P) \notin E(\mathbb{F} _{q ^k})$ならば$e(P, \psi(P)) \not= 1$となる．
\par
ペアリングの非退化について，distortion mapが用いられる場合，$E$の非線形自己準同型$\psi$を用いて，
${e} : G _1 \times G _1 \to G _3$を
\[
{e}(P, Q) = {e}(P, \psi(Q))
\]
と定義することにより，非退化において全ての$P \in G _1$において
\[
{e}(P, P) = {e}(P, \psi(P)) \not= 1
\]
である．
これは暗号方式を用いる際にかなり重要である．
一意的な値を得るためには，ペアリングの値が$1$とならない場合についてのみ考えなければいけないからである．\\
\par
\section{Supersingular curve}
\par
上記のdistortion mapを持つような$\mathbb{F} _q$上の楕円曲線$E$はsupersingularとなる．
Supersingularとは，以下の条件を1つでも満たす場合をいう．
\begin{enumerate}
  \item $\# E(\mathbb{F} _q) \equiv 1 \ (\bmod p)$ ($p \mid t$で$\# E(\mathbb{F} _q) = q + 1 - t$と等価)
  \item $E$が$\overline{\mathbb{F}} _q$上で位数$p$の点を取らない．
  \item $\overline{\mathbb{F}} _q$上の$E$の自己準同型環が非可換である．
\end{enumerate}
もし$E$がsupersingularでない場合，ordinaryであるという．
Supersingular curveは限られており，それは埋め込み次数が$6$以下であるので，
ペアリングを用いた暗号系に適している．\\
