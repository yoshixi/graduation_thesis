\chapter{ペアリング演算の高速化}
%Miller Algorithmの発展, BKLS, Duusma-Lee Algorithmについて書く. 
\section{Signed Miller Algorithm}
第4章で述べたMiller Algorithmでは部分群の位数$n$を2進展開していた. Signed Miller Algorithmは符号付き2進展開を用いる手法である. 次にそのアルゴリズムを示す.
\par
\begin{table}[htbp]
 \begin{center}
  \begin{tabular}{|l|}
     \hline
     Input: $n, \ P = (x_P,y_P) \in E(\mathbb{F}_q)[n], \ Q = (x_Q,y_Q) \in E(\mathbb{F}_{q^k})$ \\
     Output: $f \in \mathbb{F}_{q^k}$  \\
     \hline
     1: \quad $Q' \in _R E(\mathbb{F}_{q^k})$\\
     2: \quad $S=Q+Q' \in E(\mathbb{F}_{q^k})$\\
     3: \quad $V \gets P, \ f \gets 1,\ f_{-1} = \frac{1}{x_Q - x_P}$\\
     4: \quad $n=\sum^{l - 1}_{i=0} n_i 2^i, \ n_i \in \{-1,0,1\},\ n_0 = 1$\\
     5: \quad for $j \gets l - 1$ down do 0\\
     6: \quad \quad $f \gets f^2 \cdot \frac{g_{V,V}(S)g_{2V}(Q')}{g_{2V}(S)g_{V,V}(Q')}$\\
     7: \quad \quad $V \gets 2V$\\
     8: \quad if $n_j = 1$ then\\
     9: \quad \quad $f \gets f \cdot \frac{g_{V,P}(S)g_{V + P}(Q')}{g_{V + P}(S)g_{V,P}(Q')}$\\
     10: \quad \quad $V \gets V + P$\\
     11: \quad if $n_j = -1$ then\\
     12: \quad \quad $f \gets f \cdot f_{-1} \cdot \frac{g_{V,P}(S)g_{V - P}(Q')}{g_{V - P}(S)g_{V,P}(Q')}$\\
     13: \quad \quad $V \gets V - P$\\
     14: \quad return $f$\\
     \hline
   \end{tabular}
 \end{center}
 \caption{Signed Miller Algorithm}
\end{table}
このように符号付きで展開する方法は後述のアルゴリズムでも同様に用いることができる.
\clearpage 
\section{高速化手法}
supersingular curveにおけるReduced Tate ペアリングの高速化手法がBarretoらによっていくつか提案された\cite{BKLS01}. それを次に列挙する. 
\subsection{部分体の要素による乗算}
埋め込み次数$k$の因子を$d$とすると, ペアリングの値を変えずに非零な要素$x \in {F}_{q^d}をf_{n,P}(Q)$に乗じることが可能である. $q^k - 1 = (q^d - 1)\sum^{k / d - 1}_{i = 0} q^{id}$と因数分解化のであり, $k > 1のときn | q^k -  1,\ n \not | q^d - 1$となるため, $n | \sum^{k / d - 1}_{i = 0} q^{id}$である. すなわち, $(q^k - 1) / n は因子としてq^d - 1$を必ず含んでいる. よって, $f_{n,P}(Q)は最終べき乗(q^k - 1) / n$の処理を行うことにより, フェルマーの小定理より乗じた値$x^{(q^k - 1) / n} = 1$となる. 
\subsection{点による因子の置換}
ペアリングの値は, 引数として与える$Q \in E(K)$とランダムに選択される$R \in E(K)$から構成される因子$D = (Q + R) - (R)$を用いて計算されるが, 因子$Dを点Q$と置換しても正しく計算可能で$P \in E(K_0)[n],\ Q \in E(K)$は線形独立な点とするとき, 次の式が成立する. 
\par
\[
e(P,Q) = f_{n,P}(Q)^{q^k-1}
\]
\subsection{分母消去}
Supersingular Curveであれば, $Q'_1 \in E(K_0)$にdistortion mapを適用させることにより, $Q_1 = \psi (Q'_1) \in E(K)$を得る. Ordinary Curveであれば, twist $E'$上の点$Q'_2 \in E(\mathbb{F}_{q^e})からQ'_2 = \psi (Q'_2) \in E(K)を得る$. ここで, $m = \mbox{gcd}(k,d),\ e = k/m$である. よって$Q = (x,y) \in E(K)においてx \in \mathbb{F}_{q^{k/2}} となるとき$, Miller Algorithmの2倍算または加算ステップに出現する分母の要素$g_{2V},g_{V + P}はe(P,Q)$の値を変更することなく省略可能である. 
\subsection{群位数のHamming Weight}
Miller Algorithmは部分群の位数$n$に対する2進展開法に基づき, ペアリングの値を計算しているため, 加算ステップの処理回数は$n$のHamming Weight(2進展開した値における1の総数)に依存する. ランダムに選択された$n$の平均的なHamming Weightはビット長の半分程度になるが, 部分群の位数として$n = 2^\alpha \pm 2^\beta \pm 1$を選択することにより, ペアリング演算コストを大幅に抑えることが可能である. 
\subsection{最終べき乗の高速化}
Pairing-friendly field $K$における最終べき乗$(q^k - 1) / n$を想定する. $k$次の円分多項式 $\Phi _k(p)$とすれば, $n|q^k - 1$であるため, 次のように変形できる. 
\[
f^{(q^k - 1) / n} = (f^{(q^k - 1) / \Phi _k(q)})^{(\Phi _k(q) / n)}
\] 
最終べき乗のコストは$(\Phi _k(q) / n)$乗のコストと同等, $(\Phi _k(q) / n)$のビット長は$(\Phi _k(q) / k)\mbox{log} _2 (q^k) - \mbox{log} _2 (n)$となる.
\clearpage
\section{BKLS Algorithm}
前述した高速化手法を用いて, supersingular curveのdistortion map $\psi$ を利用して分母消去の手法を適用したBKLS Algorithm \cite{BKLS02}を次に示す. ordinary curveの場合, $Q' \in E'(K)$として, distortion mapではなくtwistの同型写像 $\psi _d$を用いる. 
\vspace{-0.5cm}
\par
\begin{table}[htbp]
 \begin{center}
  \begin{tabular}{|l|}
     \hline
     Input: $P,\ Q \in E(K_0)[n]$\\
     Output: $f \in K$\\
     \hline
     1: \quad $f \gets 1,\ V \gets P$\\
     2: \quad $n=\sum_{l-1}^{i=0} n_i 2^i, \ n_i \in \{0,1\}$\\
     3: \quad for $j \gets l-1$ down 0 do 0\\
     4: \quad \quad $f \gets f^2 \cdot g_{V,\ V}(\psi (Q))$\\
     5: \quad \quad $V \gets 2V$\\
     6: \quad if $n_j = 1$ then\\
     7: \quad \quad $f \gets f \cdot g_{V,\ P}(\psi (Q))$\\
     8: \quad \quad $V \gets V+P$\\
     9: \quad return $f$\\
     \hline
   \end{tabular}
 \end{center}
 \caption{BKLS Algorithm}
\end{table}
\vspace{-0.5cm}
\par
さらに, $\mathbb{F}_{3^m}$の有限体上で定義されるsupersingular curve $y^2 = x^3 - x + b,\ b \in \{-1,1\} $上の3 倍算は，$P = (x, y),\ 3P = (x_3, y_3) $とすれば, 
\vspace{-3mm}
\[
x_3 = (x^3)^3 - b
\]
\vspace{-5mm}
\[
y_3 = - (y^3)^3
\]
\vspace{-3mm}
で計算可能である．標数3 の有限体における3 乗算の計算コストは乗算と比較して小さく，効
率よく3 倍算を求めることができる．部分群の位数$n$ を3 進展開し，3 倍算に対しMiller fomula を求めることにより, Miller Algorithm の計算が可能となる．またdistortion map $\psi$ により, 分母消去の手法が適用可能である. 次にそのアルゴリズムを示す. 
\begin{table}[htbp]
 \begin{center}
  \begin{tabular}{|l|}
     \hline
     Input: $P,\ Q \in E(\mathbb{F}_{3^m})[n]$\\
     Output: $f \in \mathbb{F}_{3^{6m}}$\\
     \hline
     1: \quad $f \gets 1,\ V \gets P$\\
     2: \quad $n=\sum_{l-1}^{i=0} n_i 3^i, \ n_i \in \{-1,0,1\}$\\
     3: \quad for $j \gets l-1$ down 0 do 0\\
     4: \quad \quad $f \gets f^3 \cdot g_{V,\ -3V}(\psi (Q))$\\
     5: \quad \quad $V \gets 3V$\\
     6: \quad if $n_j = 1$ then\\
     7: \quad \quad $f \gets f \cdot g_{V,\ P}(\psi (Q))$\\
     8: \quad \quad $V \gets V+P$\\
     9: \quad if $n_j = -1$ then\\
     10: \quad \quad $f \gets f \cdot g_{V,\ -P}(\psi (Q))$\\
     11: \quad \quad $V \gets V-P$\\
     12: \quad return $f$\\
     \hline
   \end{tabular}
 \end{center}
 \caption{BKLS Algorithm supersingular curve on $\mathbb{F}_{3^m}$}
\end{table}
\par
\clearpage
\section{Duursma and Lee Algorithm}
Duursmaらは有限体$\mathbb{F}_{p^m}(p \ge 3,\ \mbox{gcd}(m,\ 2p) = 1) 上で定義された種数(p-1)/2 の超特異代数曲線C : y^2 = x^p - x + d$におけるTate ペアリングの演算アルゴリズム\cite{Duu}を提案した．特に$p = 3$のとき，標数3 の有限体における埋め込み次数$k = 6$を持つsupersingular curve に対する演算アルゴリズムとなる．Reduced Tate ペアリングの性質より，群位数$n$を基底$p$においてHamming Weight が2 となる値$p^{mp} + 1$ と置換，最終べき乗をFrobenius 写像と1 回の逆元で計算可能な値$(p^{2mp} - 1)=(p^{mp} +1) = (p^{mp} - 1)$ と置換する．この手法により，Miller Algorithm の処理及び最終べき乗が著しく簡略化され，さらに$mp$回のループ回数を$m$回への削減も実現した．
\par
超楕円曲線$C,\ d = \pm1,\ p \equiv 3 (\mbox{mod} 4) をC/\mathbb{F}_{p^m} $とする．Duursma and Lee Algorithmでは, 点を通る直線$g$を導出してMiller formula から導出せず，ある因子を持つ関数より値を計算する．$P \in C(\mathbb{F}_{p^m}) とすると，因子(p^{pm} + 1)((P) - (\mathcal{O})) $は主因子となる．
すなわち，div($f_{p^{pm}+1,P} ) = (p^{pm} +1)(P) - ((p^{pm} + 1)P) - (p^{pm})(\mathcal{O}) となる関数f_{p^{pm}+1,P} $を求める．
\par
次に標数3 の有限体上で定義されるsupersingular curve におけるTate ペアリングを求め
るDuursma and Lee Algorithmを示す．
\par
\begin{table}[htbp]
 \begin{center}
  \begin{tabular}{|l|}
     \hline
     Input: $E(\mathbb{F}_{3^m}):\ y^2 = x^3 - x + d,\ P=(\alpha,\ \beta),\ Q \in E(\mathbb{F}_{3^m}[n])$\\
     Output: $f_{3^{3m + 1},\ P}(\psi (Q)) \in \mathbb{F}_{3^{6m}}$\\
     \hline
     1: \quad $f \gets 1,\ V \gets P$\\
     2: \quad $r=\sum_{l - 1}^{i = 0} n_i 2^i, \ r_i \in \{0,1\}$\\
     3: \quad for $j \gets l - 1$ down 0 do 0\\
     4: \quad \quad $\alpha \gets \alpha ^3,\ \beta \gets \beta ^3$\\
     5: \quad \quad $g \gets \beta y \hat{\sigma}-(\alpha +x-\rho +d)^{(p+1)/2}$\\
     6: \quad \quad $f \gets f \cdot g$\\
     7: \quad \quad $x \gets x^{1/3},\ y \gets y^{1/3}$\\
     8: \quad return $f$\\
     \hline
  \end{tabular}
 \end{center}
 \caption{Duursma and Lee Algorithm}
\end{table}
\par